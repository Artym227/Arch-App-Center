#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è AUR —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
# –í–∫–ª—é—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏, –∫–æ–º–º–∏—Ç –∏ –ø—É—à

set -e

# –ü—É—Ç–∏ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º
GITHUB_REPO="/home/artym/Arch-App-Center"
AUR_REPO="/home/artym/arch-app-center"

echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ AUR —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏
"$GITHUB_REPO/scripts/update-version.sh"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ AUR —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
cd "$AUR_REPO"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
if ! git diff --quiet; then
    echo "üìù –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç..."
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    git add .
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –¥–ª—è –∫–æ–º–º–∏—Ç–∞
    NEW_VERSION=$(grep "^pkgver=" PKGBUILD | cut -d'=' -f2)
    
    # –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç
    git commit -m "Update to version $NEW_VERSION
    
    - Automatic version update from GitHub
    - Updated PKGBUILD and .SRCINFO
    - Version: $NEW_VERSION"
    
    echo "‚úÖ –ö–æ–º–º–∏—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è –≤–µ—Ä—Å–∏–∏ $NEW_VERSION"
    
    # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –ø—É—à–µ
    echo ""
    read -p "üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ AUR? (y/N): " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ AUR..."
        git push origin master
        echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ AUR!"
    else
        echo "‚è∏Ô∏è  –ü—É—à –æ—Ç–º–µ–Ω–µ–Ω. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ."
    fi
    
else
    echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. AUR —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∞–∫—Ç—É–∞–ª–µ–Ω."
fi

echo "üéâ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!" 